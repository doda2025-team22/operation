- name: Finalizing the Cluster Setup
  hosts: controller, 192.168.56.100
  tasks:
    - name: Retrieve Istio binary AMD64
      become: true
      ansible.builtin.unarchive:
        src: "./istio/istio-1.25.2-linux-amd64.tar.gz"
        dest: /usr/local/bin
        extra_opts:
          - --strip-components=2
          - --show-stored-names
          - istio-1.25.2/bin/istioctl
      when: ansible_facts['architecture'] == "x86_64"

    - name: Retrieve Istio binary ARM64
      become: true
      ansible.builtin.unarchive:
        src: "./istio/istio-1.25.2-linux-arm64.tar.gz"
        dest: /usr/local/bin
        extra_opts:
          - --strip-components=2
          - --show-stored-names
          - istio-1.25.2/bin/istioctl
      when: ansible_facts['architecture'] == "aarch64"

    - name: Add ingress-nginx chart repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: "https://kubernetes.github.io/ingress-nginx"

    - name: Deploy ingress-nginx via Helm
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        namespace: ingress-nginx
        create_namespace: true
        state: present
        values:
          controller:
            service:
              type: LoadBalancer

    - name: Ensure /tmp/metallb directory exists
      ansible.builtin.file:
        path: ~/metallb
        state: directory
        group: vagrant
        owner: vagrant
        mode: "0755"

    - name: Loop over MetalLB files and download
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/metallb/{{ item }}"
        dest: "~/metallb/{{ item }}"
        group: vagrant
        owner: vagrant
        mode: "0644"
      loop:
        - metallb-native.yaml
        - ippool.yml
        - l2advertisement.yml

    - name: Apply MetalLB CRDs
      kubernetes.core.k8s:
        state: present
        src: ~/metallb/metallb-native.yaml

    - name: Wait for MetalLB controller pods to be Ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: metallb-system
        label_selectors:
          - app=metallb
          - component=controller
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 60

    - name: Add IPAddressPool
      kubernetes.core.k8s:
        state: present
        src: ~/metallb/ippool.yml

    - name: Configure L2Advertisement
      kubernetes.core.k8s:
        state: present
        src: ~/metallb/l2advertisement.yml

    - name: Add kubernetes-dashboard Helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: "https://kubernetes.github.io/dashboard"

    - name: Deploy Kubernetes Dashboard via Helm
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        namespace: kubernetes-dashboard
        create_namespace: true
        state: present

    - name: Create admin-user ServiceAccount for Dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard

    - name: Bind admin-user to cluster-admin role
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user-cluster-admin
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: kubernetes-dashboard
          roleRef:
            kind: ClusterRole
            name: cluster-admin
            apiGroup: rbac.authorization.k8s.io

    - name: Create Ingress for Kubernetes Dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: kubernetes-dashboard
            namespace: kubernetes-dashboard
            annotations:
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            ingressClassName: nginx
            tls:
              - hosts:
                  - dashboard.local
                secretName: dashboard-tls
            rules:
              - host: "dashboard.local"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: kubernetes-dashboard-kong-proxy
                          port:
                            number: 443

    - name: Ensure Istio directory exists
      ansible.builtin.file:
        path: /home/vagrant/istio
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Create IstioOperator config for ingressgateway LoadBalancer IP
      ansible.builtin.copy:
        dest: /home/vagrant/istio/istio-operator.yaml
        owner: vagrant
        group: vagrant
        mode: "0644"
        content: |
          apiVersion: install.istio.io/v1alpha1
          kind: IstioOperator
          metadata:
            name: istio-controlplane
            namespace: istio-system
          spec:
            profile: default
            components:
              ingressGateways:
                - name: istio-ingressgateway
                  enabled: true
                  k8s:
                    service:
                      type: LoadBalancer
                      loadBalancerIP: 192.168.56.91

    - name: Check if Istio control plane is installed
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: istio-system
        name: istiod
      register: istio_deploy

    - name: Install Istio control plane
      ansible.builtin.command:
        cmd: istioctl install -y -f /home/vagrant/istio/istio-operator.yaml
      when: istio_deploy.resources | length == 0
