- name: Finalizing the Cluster Setup
  hosts: controller, 192.168.56.100
  tasks:
    - name: Ensure /tmp/metallb directory exists
      ansible.builtin.file:
        path: ~/metallb
        state: directory
        group: vagrant
        owner: vagrant
        mode: "0755"

    - name: Loop over MetalLB files and download
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/metallb/{{ item }}"
        dest: "~/metallb/{{ item }}"
        group: vagrant
        owner: vagrant
        mode: "0644"
      loop:
        - metallb-native.yaml
        - ippool.yml
        - l2advertisement.yml

    - name: Apply MetalLB CRDs
      ansible.builtin.command:
        cmd: kubectl apply -f metallb-native.yaml
      args:
        chdir: ~/metallb/

    - name: Wait step
      ansible.builtin.command:
        cmd: kubectl wait -n metallb-system -l app=metallb,component=controller --for=condition=ready pod --timeout=60s
      register: metallb_wait
      retries: 5
      delay: 10
      until: metallb_wait.rc == 0

    - name: Add IPAddressPool
      ansible.builtin.command:
        cmd: kubectl apply -f ippool.yml
      args:
        chdir: ~/metallb/

    - name: Configure L2Advertisement
      ansible.builtin.command:
        cmd: kubectl apply -f l2advertisement.yml
      args:
        chdir: ~/metallb/

    - name: Add ingress-nginx chart repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: "https://kubernetes.github.io/ingress-nginx"

    - name: Deploy ingress-nginx via Helm
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        namespace: ingress-nginx
        create_namespace: true
        state: present
        values:
          controller:
            service:
              type: LoadBalancer

    - name: Add kubernetes-dashboard Helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: "https://kubernetes.github.io/dashboard"

    - name: Deploy Kubernetes Dashboard via Helm
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        namespace: kubernetes-dashboard
        create_namespace: true
        state: present

    - name: Create admin-user ServiceAccount for Dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard

    - name: Bind admin-user to cluster-admin role
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user-cluster-admin
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: kubernetes-dashboard
          roleRef:
            kind: ClusterRole
            name: cluster-admin
            apiGroup: rbac.authorization.k8s.io

    - name: Create Ingress for Kubernetes Dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: kubernetes-dashboard
            namespace: kubernetes-dashboard
            annotations:
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            ingressClassName: nginx
            tls:
              - hosts:
                  - dashboard.192-168-56-90.sslip.io
                secretName: dashboard-tls
            rules:
              - host: "dashboard.192-168-56-90.sslip.io"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: kubernetes-dashboard-kong-proxy
                          port:
                            number: 443

    - name: Ensure Istio directory exists
      ansible.builtin.file:
        path: /home/vagrant/istio
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    # IMPORTANT: The Istio version and download link should match. Adjust accordingly.
    - name: Download Istio 1.25.2 archive
      ansible.builtin.get_url:
        url: "https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-arm64.tar.gz"
        dest: /home/vagrant/istio/istio-1.25.2-linux-arm64.tar.gz
        mode: "0644"
        owner: vagrant
        group: vagrant

    - name: Extract Istio 1.25.2
      ansible.builtin.unarchive:
        src: /home/vagrant/istio/istio-1.25.2-linux-arm64.tar.gz
        dest: /home/vagrant/istio
        remote_src: true
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Link istioctl into /usr/local/bin
      become: true
      ansible.builtin.file:
        src: /home/vagrant/istio/istio-1.25.2/bin/istioctl
        dest: /usr/local/bin/istioctl
        state: link
        mode: "0755"

    - name: Create IstioOperator config for ingressgateway LoadBalancer IP
      ansible.builtin.copy:
        dest: /home/vagrant/istio/istio-operator.yaml
        owner: vagrant
        group: vagrant
        mode: "0644"
        content: |
          apiVersion: install.istio.io/v1alpha1
          kind: IstioOperator
          metadata:
            name: istio-controlplane
            namespace: istio-system
          spec:
            profile: default
            components:
              ingressGateways:
                - name: istio-ingressgateway
                  enabled: true
                  k8s:
                    service:
                      type: LoadBalancer
                      loadBalancerIP: 192.168.56.91

    - name: Install Istio control plane
      ansible.builtin.command:
        cmd: istioctl install -y -f /home/vagrant/istio/istio-operator.yaml
      args:
        chdir: /home/vagrant/istio/
