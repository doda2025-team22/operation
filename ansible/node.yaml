- name: Kubernetes Node Setup
  hosts: nodes
  tasks:
    - name: Wait for SSH to come up on node
      ansible.builtin.wait_for_connection:
        timeout: 60

    - name: Get Kubeadm Join Command
      ansible.builtin.command: kubeadm token create --print-join-command
      delegate_to: ctrl
      register: join_command

    - name: Join Node
      become: true
      ansible.builtin.shell:
        cmd: "{{ join_command.stdout }}"
        creates: /etc/kubernetes/kubelet.conf
